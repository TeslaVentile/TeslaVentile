<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Messreihen</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1630;
      --text:#eef1ff;
      --muted:#b9c2ee;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --danger:#ff6e6e;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 10%, #132049 0%, var(--bg) 55%) fixed;
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 90px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .title h1{
      font-size: 20px;
      margin:0 0 6px;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .home-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (min-width: 760px){
      .home-grid{ grid-template-columns: repeat(3, 1fr); }
      .title h1{ font-size: 24px; }
    }

    .action{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(18,26,51,.65);
      cursor:pointer;
      text-align:left;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      color: var(--text);
    }
    .action:hover{ background: rgba(18,26,51,.78); }
    .action:active{ transform: translateY(1px); }

    .action .kicker{ font-size: 12px; color: var(--muted); }
    .action .name{
      font-size: 20px;
      font-weight: 800;
      margin: 2px 0;
      color: var(--text);
      letter-spacing:.2px;
      text-shadow: 0 1px 0 rgba(0,0,0,.25);
    }
    .action .desc{ font-size: 13px; color: var(--muted); line-height: 1.35; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 700;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.35); }
    .btn.danger{ background: rgba(255,110,110,.14); border-color: rgba(255,110,110,.30); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .btn.lap{
      font-size: 18px;
      padding: 16px 18px;
      border-radius: 14px;
      min-width: 160px;
    }
    @media (min-width: 760px){
      .btn.lap{ min-width: 220px; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 999;
    }
    .modal-backdrop.open{ display:flex; }

    .modal{
      width: min(980px, 100%);
      max-height: calc(100dvh - 28px);
      background: rgba(15,22,48,.96);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .modal-head h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }

    .modal-body{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal-foot{
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      display:none;
    }
    .modal-foot.open{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 760px){
      .grid.cols2{ grid-template-columns: 1.1fr .9fr; }
      .grid.cols2b{ grid-template-columns: .9fr 1.1fr; }
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 150px;
      flex: 1;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    select, input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }

    .bigtime{
      font-variant-numeric: tabular-nums;
      font-size: 42px;
      letter-spacing: .4px;
      margin: 8px 0 4px;
    }
    .subtime{
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }

    .list{
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .item:first-child{ border-top: 0; }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .item .meta .name{
      font-weight: 800;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .meta .small{
      color: var(--muted);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(18,26,51,.95);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 1000;
      font-size: 13px;
      max-width: min(95vw, 980px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    .chart-wrap{
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 10px;
      overflow:hidden;
    }
    canvas{ width:100%; height:320px; display:block; }

    .checkboxes{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 8px;
    }
    .chk{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .chk input{ transform: scale(1.1); }
    .legend-dot{
      width:10px; height:10px; border-radius: 99px;
      background: currentColor;
      display:inline-block;
      opacity: .9;
      flex: 0 0 auto;
    }
    .mono{ font-variant-numeric: tabular-nums; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Messreihen</h1>
        <p>Messen, speichern und vergleichen – direkt im Browser.</p>
      </div>

      <div class="pill" id="statsPill">0 Messreihen</div>
    </header>

    <div class="home-grid">
      <button class="action" id="openMeasure" type="button">
        <div class="kicker">1</div>
        <div class="name">Messen</div>
        <div class="desc">Neue Messreihe aufnehmen (5 Runden, Windungszahl & Richtung).</div>
      </button>

      <button class="action" id="openAnalyze" type="button">
        <div class="kicker">2</div>
        <div class="name">Auswerten</div>
        <div class="desc">Graphen anzeigen und mehrere Messreihen vergleichen.</div>
      </button>

      <button class="action" id="openData" type="button">
        <div class="kicker">3</div>
        <div class="name">Daten</div>
        <div class="desc">Messreihen anzeigen und gezielt löschen.</div>
      </button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <h2 id="modalTitle">Fenster</h2>
        <div class="row">
          <button class="btn" id="closeModal" type="button">Schließen</button>
        </div>
      </div>

      <div class="modal-body" id="modalBody"></div>

      <div class="modal-foot" id="modalFoot"></div>
    </div>
  </div>

  <template id="tplMeasure">
    <div class="grid cols2">
      <div class="card">
        <div class="row">
          <div class="field" style="max-width:220px;">
            <label for="windings">Windungszahl</label>
            <select id="windings">
              <option value="1">1</option>
              <option value="3">3</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="field" style="max-width:240px;">
            <label for="direction">Richtung</label>
            <select id="direction">
              <option value="Vorwärts">Vorwärts</option>
              <option value="Rückwärts">Rückwärts</option>
            </select>
          </div>
          <div class="field">
            <label>Name</label>
            <input id="seriesName" type="text" readonly />
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="bigtime mono" id="runningTime">0.000</div>
          <p class="subtime" id="runningHint">Zum Starten „Runde“ drücken.</p>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between;">
          <div class="pill">Runden: <span class="mono" id="roundCount">0</span>/5</div>
          <div class="pill">Anzeige: Sekunden (0.001)</div>
        </div>
      </div>

      <div class="card">
        <div class="pill" style="margin-bottom:10px;">Gemessene Runden</div>
        <div class="list" id="lapList" style="max-height: 360px; overflow:auto; -webkit-overflow-scrolling:touch;"></div>
      </div>
    </div>
  </template>

  <template id="tplAnalyze">
    <div class="grid cols2b">
      <div class="card">
        <div class="row">
          <div class="field">
            <label for="mode">Darstellung</label>
            <select id="mode">
              <option value="selected">Ausgewählte Messreihen (Vergleich)</option>
              <option value="windingAvg">Mittelwerte nach Windungszahl</option>
              <option value="dirAvg">Mittelwerte nach Richtung</option>
              <option value="windingDirAvg">Mittelwerte nach Windungszahl + Richtung</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn" id="selectAllBtn" type="button">Alle</button>
          <button class="btn" id="selectNoneBtn" type="button">Keine</button>
        </div>

        <div class="checkboxes" id="seriesChecks"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div class="pill">X: Runde (1–5) · Y: Zeit (s)</div>
          <button class="btn" id="redrawBtn" type="button">Neu zeichnen</button>
        </div>

        <div class="chart-wrap" style="margin-top:10px;">
          <canvas id="chart" width="900" height="500"></canvas>
        </div>

        <p class="subtime" id="chartHelp" style="margin-top:10px;"></p>
      </div>
    </div>
  </template>

  <template id="tplData">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill" id="dataCount">0 Messreihen</div>
        <button class="btn danger" id="deleteAllBtn" type="button">Alle löschen</button>
      </div>

      <div style="margin-top:10px;" class="list" id="dataList"></div>
    </div>
  </template>

  <script>
    const STORAGE_KEY = "messreihen_v1";

    /** @typedef {{ id:string, name:string, windings:number, direction:"Vorwärts"|"Rückwärts", lapsMs:number[], createdAt:number }} Series */

    /** @returns {Series[]} */
    function loadSeries(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed.filter(s =>
          s && typeof s.id==="string" && typeof s.name==="string" &&
          typeof s.windings==="number" &&
          (s.direction==="Vorwärts" || s.direction==="Rückwärts") &&
          Array.isArray(s.lapsMs) && s.lapsMs.length===5
        );
      }catch{
        return [];
      }
    }

    /** @param {Series[]} arr */
    function saveSeries(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      refreshStats();
    }

    function refreshStats(){
      const count = loadSeries().length;
      document.getElementById("statsPill").textContent = `${count} Messreihen`;
    }

    let toastTimer = null;
    function showToast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), 2200);
    }

    // Modal
    const backdrop = document.getElementById("backdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFoot = document.getElementById("modalFoot");
    const closeModalBtn = document.getElementById("closeModal");

    function setModalFoot(html){
      modalFoot.innerHTML = html || "";
      if(html){
        modalFoot.classList.add("open");
      }else{
        modalFoot.classList.remove("open");
      }
    }

    function openModal(title, templateId, initFn){
      modalTitle.textContent = title;
      modalBody.innerHTML = "";
      setModalFoot("");

      const tpl = document.getElementById(templateId);
      modalBody.appendChild(tpl.content.cloneNode(true));

      backdrop.classList.add("open");
      backdrop.setAttribute("aria-hidden","false");
      closeModalBtn.focus({preventScroll:true});

      if(typeof initFn === "function") initFn();
    }

    function closeModal(){
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden","true");
      modalBody.innerHTML = "";
      setModalFoot("");
    }

    closeModalBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeModal(); });

    // Messen
    function initMeasure(){
      const windingsEl = document.getElementById("windings");
      const directionEl = document.getElementById("direction");
      const nameEl = document.getElementById("seriesName");
      const runningTimeEl = document.getElementById("runningTime");
      const runningHintEl = document.getElementById("runningHint");
      const lapList = document.getElementById("lapList");
      const roundCountEl = document.getElementById("roundCount");

      setModalFoot(`
        <div class="row" style="justify-content:space-between; align-items:center;">
          <button class="btn primary lap" id="lapBtn" type="button">Runde</button>
          <button class="btn" id="resetBtn" type="button">Zurücksetzen</button>
        </div>
      `);

      const lapBtn = document.getElementById("lapBtn");
      const resetBtn = document.getElementById("resetBtn");

      let rafId = null;
      let running = false;
      let lapStartMs = 0;
      let currentLapElapsedMs = 0;
      /** @type {number[]} */
      let lapsMs = [];

      function baseName(){
        const w = Number(windingsEl.value);
        const d = directionEl.value;
        return `W${w} ${d}`;
      }

      function uniqueName(base){
        const all = loadSeries();
        const same = all.map(s => s.name).filter(n => n.startsWith(base));
        if(same.length === 0) return base;
        let maxN = 1;
        for(const n of same){
          const m = n.match(/\((\d+)\)\s*$/);
          if(m) maxN = Math.max(maxN, Number(m[1]));
        }
        return `${base} (${maxN + 1})`;
      }

      function updateName(){ nameEl.value = baseName(); }

      function fmtMs(msInt){ return (msInt / 1000).toFixed(3); }

      function renderLaps(){
        lapList.innerHTML = "";
        if(lapsMs.length === 0){
          lapList.innerHTML = `
            <div class="item">
              <div class="meta">
                <div class="name">Noch keine Runden</div>
                <div class="small">Zum Starten „Runde“ drücken.</div>
              </div>
            </div>`;
        }else{
          lapsMs.forEach((ms, idx) => {
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div class="meta">
                <div class="name">Runde ${idx+1}</div>
                <div class="small mono">${fmtMs(ms)} s</div>
              </div>
              <span class="pill mono">${fmtMs(ms)} s</span>
            `;
            lapList.appendChild(div);
          });
        }
        roundCountEl.textContent = String(lapsMs.length);
      }

      function stopRAF(){
        if(rafId !== null){
          cancelAnimationFrame(rafId);
          rafId = null;
        }
      }

      function tick(){
        if(!running) return;
        const now = performance.now();
        currentLapElapsedMs = Math.max(0, Math.round(now - lapStartMs));
        runningTimeEl.textContent = fmtMs(currentLapElapsedMs);
        rafId = requestAnimationFrame(tick);
      }

      function resetAll(){
        running = false;
        stopRAF();
        lapsMs = [];
        currentLapElapsedMs = 0;
        runningTimeEl.textContent = "0.000";
        runningHintEl.textContent = "Zum Starten „Runde“ drücken.";
        lapBtn.disabled = false;
        renderLaps();
      }

      function saveIfComplete(){
        if(lapsMs.length !== 5) return;

        const windings = Number(windingsEl.value);
        const direction = /** @type {"Vorwärts"|"Rückwärts"} */ (directionEl.value);
        const base = baseName();
        const finalName = uniqueName(base);

        /** @type {Series} */
        const series = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
          name: finalName,
          windings,
          direction,
          lapsMs: lapsMs.slice(0,5),
          createdAt: Date.now()
        };

        const all = loadSeries();
        all.push(series);
        saveSeries(all);

        showToast(`Gespeichert: ${finalName}`);
        resetAll();
      }

      windingsEl.addEventListener("change", () => { updateName(); resetAll(); });
      directionEl.addEventListener("change", () => { updateName(); resetAll(); });

      lapBtn.addEventListener("click", () => {
        if(!running){
          running = true;
          lapStartMs = performance.now();
          currentLapElapsedMs = 0;
          runningHintEl.textContent = "Läuft…";
          stopRAF();
          rafId = requestAnimationFrame(tick);
          return;
        }

        const now = performance.now();
        const lapMs = Math.max(0, Math.round(now - lapStartMs));
        lapsMs.push(lapMs);

        lapStartMs = now;
        currentLapElapsedMs = 0;
        runningTimeEl.textContent = "0.000";
        renderLaps();

        if(lapsMs.length >= 5){
          running = false;
          stopRAF();
          lapBtn.disabled = true;
          saveIfComplete();
        }
      });

      resetBtn.addEventListener("click", resetAll);

      updateName();
      renderLaps();
    }

    // Auswertung
    const PALETTE = ["#6ea8ff","#7dffcf","#ffb86e","#ff6edb","#a98bff","#57e38f","#ffd36e","#6efff0","#ff6e6e"];

    function initAnalyze(){
      const modeEl = document.getElementById("mode");
      const seriesChecksEl = document.getElementById("seriesChecks");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const selectNoneBtn = document.getElementById("selectNoneBtn");
      const redrawBtn = document.getElementById("redrawBtn");
      const canvas = document.getElementById("chart");
      const helpEl = document.getElementById("chartHelp");
      const ctx = canvas.getContext("2d");

      const all = loadSeries().sort((a,b) => b.createdAt - a.createdAt);
      /** @type {Set<string>} */
      const selectedIds = new Set(all.map(s => s.id));

      function escapeHtml(str){
        return String(str)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function buildChecks(){
        seriesChecksEl.innerHTML = "";
        if(all.length === 0){
          seriesChecksEl.innerHTML = `<div class="chk"><span>Keine Messreihen vorhanden.</span></div>`;
          return;
        }
        all.forEach((s, idx) => {
          const color = PALETTE[idx % PALETTE.length];
          const wrap = document.createElement("label");
          wrap.className = "chk";
          wrap.style.color = color;
          wrap.innerHTML = `
            <input type="checkbox" ${selectedIds.has(s.id) ? "checked" : ""} />
            <span class="legend-dot"></span>
            <span style="color: var(--text); min-width:0;">
              <div style="font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(s.name)}</div>
              <div class="subtime mono" style="margin-top:2px;">W${s.windings} · ${escapeHtml(s.direction)}</div>
            </span>
          `;
          const cb = wrap.querySelector("input");
          cb.addEventListener("change", () => {
            if(cb.checked) selectedIds.add(s.id); else selectedIds.delete(s.id);
            draw();
          });
          seriesChecksEl.appendChild(wrap);
        });
      }

      function getSelectedSeries(){
        return all.filter(s => selectedIds.has(s.id));
      }

      /** @param {Series[]} series */
      function makeLines(series){
        const mode = modeEl.value;
        if(mode === "selected"){
          return series.map((s, idx) => ({ label: s.name, lapsMs: s.lapsMs, color: PALETTE[idx % PALETTE.length] }));
        }

        const groups = new Map();
        function keyFor(s){
          if(mode === "windingAvg") return `W${s.windings}`;
          if(mode === "dirAvg") return s.direction;
          return `W${s.windings} · ${s.direction}`;
        }

        for(const s of series){
          const key = keyFor(s);
          if(!groups.has(key)) groups.set(key, { label:key, sum:[0,0,0,0,0], n:0 });
          const g = groups.get(key);
          for(let i=0;i<5;i++) g.sum[i] += s.lapsMs[i];
          g.n += 1;
        }

        const keys = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b,"de"));
        return keys.map((k, idx) => {
          const g = groups.get(k);
          const avg = g.sum.map(v => Math.round(v / g.n));
          return { label: `${g.label} (n=${g.n})`, lapsMs: avg, color: PALETTE[idx % PALETTE.length] };
        });
      }

      function clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

      function draw(){
        const selected = getSelectedSeries();
        if(all.length === 0){
          clear(); helpEl.textContent = "Keine Daten."; return;
        }
        if(selected.length === 0){
          clear(); helpEl.textContent = "Keine Auswahl."; return;
        }

        const lines = makeLines(selected);
        const pad = {l:60, r:18, t:18, b:46};
        const w = canvas.width, h = canvas.height;
        const plotW = w - pad.l - pad.r;
        const plotH = h - pad.t - pad.b;

        let maxY = 1;
        for(const ln of lines) for(const ms of ln.lapsMs) maxY = Math.max(maxY, ms);
        maxY = Math.ceil(maxY * 1.08);

        const xFor = (i) => pad.l + (plotW * (i / 4));
        const yFor = (ms) => pad.t + plotH * (1 - (ms / maxY));

        clear();

        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,.08)";
        ctx.lineWidth = 1;
        for(let g=0; g<=4; g++){
          const y = pad.t + plotH * (g/4);
          ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(w - pad.r, y); ctx.stroke();
        }
        for(let i=0; i<5; i++){
          const x = xFor(i);
          ctx.beginPath(); ctx.moveTo(x, pad.t); ctx.lineTo(x, h - pad.b); ctx.stroke();
        }
        ctx.restore();

        ctx.save();
        ctx.fillStyle = "rgba(232,236,255,.92)";
        ctx.font = "12px ui-sans-serif, system-ui, -apple-system";
        ctx.textAlign = "center";
        for(let i=0;i<5;i++) ctx.fillText(String(i+1), xFor(i), h - 20);

        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(185,194,238,.95)";
        for(let g=0; g<=4; g++){
          const ms = Math.round(maxY * (1 - g/4));
          const y = pad.t + plotH * (g/4);
          ctx.fillText((ms/1000).toFixed(3), pad.l - 10, y + 4);
        }
        ctx.restore();

        for(const ln of lines){
          ctx.save();
          ctx.strokeStyle = ln.color;
          ctx.fillStyle = ln.color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ln.lapsMs.forEach((ms, i) => {
            const x = xFor(i), y = yFor(ms);
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          });
          ctx.stroke();
          ln.lapsMs.forEach((ms, i) => {
            const x = xFor(i), y = yFor(ms);
            ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
          });
          ctx.restore();
        }

        ctx.save();
        ctx.font = "12px ui-sans-serif, system-ui, -apple-system";
        ctx.textAlign = "left";
        let lx = pad.l + 6, ly = pad.t + 6;
        for(const ln of lines.slice(0, 8)){
          ctx.fillStyle = ln.color;
          ctx.fillRect(lx, ly+3, 10, 10);
          ctx.fillStyle = "rgba(232,236,255,.92)";
          ctx.fillText(ln.label, lx + 16, ly + 12);
          ly += 18;
        }
        if(lines.length > 8){
          ctx.fillStyle = "rgba(185,194,238,.9)";
          ctx.fillText(`+${lines.length-8} weitere`, lx + 16, ly + 12);
        }
        ctx.restore();

        helpEl.textContent = `${modeEl.options[modeEl.selectedIndex].textContent} · Auswahl: ${selected.length}`;
      }

      buildChecks();
      draw();

      selectAllBtn.addEventListener("click", () => {
        all.forEach(s => selectedIds.add(s.id));
        buildChecks(); draw();
      });
      selectNoneBtn.addEventListener("click", () => {
        selectedIds.clear();
        buildChecks(); draw();
      });
      redrawBtn.addEventListener("click", draw);
      modeEl.addEventListener("change", draw);
    }

    // Daten
    function initData(){
      const dataCount = document.getElementById("dataCount");
      const dataList = document.getElementById("dataList");
      const deleteAllBtn = document.getElementById("deleteAllBtn");

      function fmtMs(ms){ return (ms/1000).toFixed(3); }
      function fmtDate(ts){
        const d = new Date(ts);
        const pad = (n) => String(n).padStart(2,"0");
        return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function escapeHtml(str){
        return String(str)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function render(){
        const all = loadSeries().sort((a,b)=>b.createdAt - a.createdAt);
        dataCount.textContent = `${all.length} Messreihen`;
        dataList.innerHTML = "";

        if(all.length === 0){
          dataList.innerHTML = `<div class="item"><div class="meta"><div class="name">Keine Messreihen vorhanden</div><div class="small">Bitte zuerst messen.</div></div></div>`;
          return;
        }

        for(const s of all){
          const total = s.lapsMs.reduce((a,b)=>a+b,0);
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="meta">
              <div class="name">${escapeHtml(s.name)}</div>
              <div class="small mono">W${s.windings} · ${escapeHtml(s.direction)} · ${fmtMs(total)} s · ${fmtDate(s.createdAt)}</div>
            </div>
            <button class="btn danger" type="button">Löschen</button>
          `;
          row.querySelector("button").addEventListener("click", () => {
            const next = loadSeries().filter(x => x.id !== s.id);
            saveSeries(next);
            showToast(`Gelöscht: ${s.name}`);
            render();
          });
          dataList.appendChild(row);
        }
      }

      deleteAllBtn.addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        refreshStats();
        showToast("Alle Messreihen gelöscht.");
        render();
      });

      render();
    }

    document.getElementById("openMeasure").addEventListener("click", () => openModal("Messen", "tplMeasure", initMeasure));
    document.getElementById("openAnalyze").addEventListener("click", () => openModal("Auswerten", "tplAnalyze", initAnalyze));
    document.getElementById("openData").addEventListener("click", () => openModal("Daten", "tplData", initData));

    refreshStats();
  </script>
</body>
</html>